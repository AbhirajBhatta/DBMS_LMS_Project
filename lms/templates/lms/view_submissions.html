{% extends 'base.html' %}
{% block title %}Submissions â€” {{ assignment.title }}{% endblock %}
{% block content %}

<div class="container mt-4">
  <h4 class="text-light mb-3">Submissions â€” {{ assignment.title }}</h4>

  <input type="text" id="search" class="form-control bg-dark text-light border-secondary mb-3"
         placeholder="Search by register number...">

  <table class="table table-dark table-hover">
    <thead>
      <tr>
        <th>Student</th>
        <th>Register No</th>
        <th>File</th>
        <th>Submitted At</th>
        <th>Resubmissions</th>
        <th>Marks</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="submissionTable">
      {% for s in submissions %}
      <tr>
        <td>{{ s.student.username }}</td>
        <td>{{ s.student.profile.reg_no }}</td>
        <td>
          {% if s.file %}
            <a href="{{ s.file.url }}" target="_blank" class="text-info">{{ s.file.name|slice:"-25:" }}</a>
          {% else %}
            <span class="text-secondary">No file</span>
          {% endif %}
        </td>
        <td>{{ s.submitted_at|date:"Y-m-d H:i" }}</td>

        <td>
          {% if s.history.all %}
            <span class="text-info">â†“ {{ s.history.count }} times</span>
            <ul class="mt-2 mb-0 ps-3 small text-secondary" style="list-style:none;">
              {% for h in s.history.all|dictsortreversed:"timestamp" %}
                <li>
                  {% if h.action == "Resubmission" %}
                    ğŸ” Resubmitted â€” {{ h.timestamp|date:"Y-m-d H:i" }}
                  {% else %}
                    âœ… Submitted â€” {{ h.timestamp|date:"Y-m-d H:i" }}
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <span class="text-muted">No history</span>
          {% endif %}
        </td>

        <td>{{ s.marks|default:"-" }}</td>
        <td>
          <a href="{% url 'grade_submission' s.id %}" class="btn btn-sm btn-success">Grade</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
const search = document.getElementById('search');
search.addEventListener('keyup', function() {
  let filter = this.value.toLowerCase();
  let rows = document.querySelectorAll('#submissionTable tr');
  rows.forEach(r => {
    let text = r.children[1].textContent.toLowerCase();
    r.style.display = text.includes(filter) ? '' : 'none';
  });
});
</script>

{% endblock %}
