{% extends 'base.html' %}
{% block title %}Submissions â€” {{ assignment.title }}{% endblock %}
{% block content %}

<div class="container mt-4">
  <h4 class="text-light mb-3">Submissions â€” {{ assignment.title }}</h4>

  <input type="text"
         id="search"
         class="form-control bg-dark text-light border-secondary mb-3"
         placeholder="ðŸ” Search by register number...">

  {% if submissions %}
  <table class="table table-dark table-striped align-middle text-center">
    <thead class="table-secondary text-dark">
      <tr>
        <th>Student</th>
        <th>Register No</th>
        <th>File</th>
        <th>Submitted At</th>
        <th>Resubmissions</th>
        <th>Marks</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="submissionTable">
      {% for s in submissions %}
      <tr>
        <td class="fw-semibold text-light">{{ s.student.username }}</td>
        <td class="text-secondary">{{ s.student.profile.reg_no }}</td>

        <td>
          {% if s.file %}
            <a href="{{ s.file.url }}" target="_blank" class="text-info text-decoration-none">
              {{ s.file.name|slice:"-40:" }}
            </a>
          {% else %}
            <span class="text-secondary">No file</span>
          {% endif %}
        </td>

        <td class="text-light">{{ s.submitted_at|date:"Y-m-d H:i" }}</td>

        <td>
          {% if s.history.all %}
            <details>
              <summary class="text-info">
                {{ s.history.count }} time{{ s.history.count|pluralize }}
              </summary>
              <ul class="list-unstyled small mt-2 mb-0">
                {% for h in s.history.all %}
                  <li class="text-secondary">
                    â€¢ {{ h.action|title }} on {{ h.submitted_at|date:"Y-m-d H:i" }}
                  </li>
                {% endfor %}
              </ul>
            </details>
          {% else %}
            <span class="text-secondary">-</span>
          {% endif %}
        </td>

        <td>
          {% if s.marks %}
            <span class="text-success fw-bold">{{ s.marks }}</span>
          {% else %}
            <span class="text-secondary">-</span>
          {% endif %}
        </td>

        <td>
          <a href="{% url 'grade_submission' s.id %}" class="btn btn-sm btn-success">Grade</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% else %}
    <p class="text-secondary">No submissions yet.</p>
  {% endif %}
</div>

<script>
// Simple client-side search by Register Number
const search = document.getElementById('search');
search.addEventListener('keyup', function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll('#submissionTable tr');
  rows.forEach(r => {
    const regNo = r.children[1].textContent.toLowerCase();
    r.style.display = regNo.includes(filter) ? '' : 'none';
  });
});
</script>

{% endblock %}
